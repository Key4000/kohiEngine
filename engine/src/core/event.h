#pragma once
#include "defines.h"

/*
 * Контекст события - универсальная структура для передачи данных между отправителем и получателем.
 * Размер: ровно 128 бит (16 байт), что оптимально для передачи по значению.
 * 
 * Использует union для предоставления разных представлений одних и тех же данных.
 * Это позволяет передавать данные разного типа в одном контексте.
 */
typedef struct event_context {
    // 128 bytes - размер всей структуры
    union {
        i64 i64[2];  // 2 × 64-битных целых числа
        u64 u64[2];  // 2 × 64-битных беззнаковых числа
        f64 f64[2];  // 2 × 64-битных числа с плавающей точкой

        i32 i32[4];  // 4 × 32-битных целых числа
        u32 u32[4];  // 4 × 32-битных беззнаковых числа
        f32 f32[4];  // 4 × 32-битных числа с плавающей точкой

        i16 i16[8];  // 8 × 16-битных целых числа
        u16 u16[8];  // 8 × 16-битных беззнаковых числа

        i8 i8[16];   // 16 × 8-битных целых числа
        u8 u8[16];   // 16 × 8-битных беззнаковых числа

        char c[16];  // 16 символов (для строк)
    } data;
} event_context;

/*
 * Тип указателя на функцию-обработчик события.
 * 
 * Параметры:
 *   code - код события (идентификатор)
 *   sender - указатель на объект, отправивший событие
 *   listener_inst - указатель на экземпляр слушателя
 *   data - контекст события с данными
 * 
 * Возвращает:
 *   TRUE - событие обработано, не передавать другим слушателям
 *   FALSE - событие не обработано, продолжить передачу
 */
typedef b8 (*PFN_on_event)(u16 code, void* sender, void* listener_inst, event_context data);

/*
 * Инициализирует систему событий.
 * Должна быть вызвана перед использованием любых функций событий.
 * 
 * Возвращает:
 *   TRUE - инициализация успешна
 *   FALSE - ошибка инициализации
 */
b8 event_initialize();

/*
 * Завершает работу системы событий.
 * Освобождает все ресурсы, удаляет регистрации.
 */
void event_shutdown();

/**
 * Регистрирует слушателя для определённого кода события.
 * Дубликаты (одинаковые listener + callback) не регистрируются повторно.
 * 
 * Параметры:
 *   code - код события для прослушивания
 *   listener - указатель на экземпляр слушателя (может быть NULL)
 *   on_event - функция-обработчик события
 * 
 * Возвращает:
 *   TRUE - успешная регистрация
 *   FALSE - ошибка регистрации (дубликат или другая ошибка)
 */
KAPI b8 event_register(u16 code, void* listener, PFN_on_event on_event);

/**
 * Отменяет регистрацию слушателя для определённого кода события.
 * 
 * Параметры:
 *   code - код события, для которого отменяется прослушивание
 *   listener - указатель на экземпляр слушателя (должен совпадать с регистрацией)
 *   on_event - функция-обработчик (должна совпадать с регистрацией)
 * 
 * Возвращает:
 *   TRUE - успешная отмена регистрации
 *   FALSE - регистрация не найдена
 */
KAPI b8 event_unregister(u16 code, void* listener, PFN_on_event on_event);

/**
 * Отправляет (вызывает) событие всем зарегистрированным слушателям.
 * Если какой-либо обработчик возвращает TRUE, рассылка прекращается.
 * 
 * Параметры:
 *   code - код события для отправки
 *   sender - указатель на отправителя события (может быть NULL)
 *   context - контекст события с данными
 * 
 * Возвращает:
 *   TRUE - событие было обработано каким-либо слушателем
 *   FALSE - никто не обработал событие
 */
KAPI b8 event_fire(u16 code, void* sender, event_context context);


/*
 * Системные коды событий (внутренние для движка).
 * Приложение должно использовать коды начиная с 256 (0x100) и выше.
 * 
 * Диапазоны:
 *   0x0001-0x00FF - системные события движка
 *   0x0100-0xFFFF - пользовательские события приложения
 */
typedef enum system_event_code {
    // Завершение работы приложения на следующем кадре
    EVENT_CODE_APPLICATION_QUIT = 0x01,

    // Нажата клавиша клавиатуры
    /* Использование контекста:
     * u16 key_code = data.data.u16[0];
     */
    EVENT_CODE_KEY_PRESSED = 0x02,

    // Отпущена клавиша клавиатуры
    /* Использование контекста:
     * u16 key_code = data.data.u16[0];
     */
    EVENT_CODE_KEY_RELEASED = 0x03,

    // Нажата кнопка мыши
    /* Использование контекста:
     * u16 button = data.data.u16[0];
     */
    EVENT_CODE_BUTTON_PRESSED = 0x04,

    // Отпущена кнопка мыши
    /* Использование контекста:
     * u16 button = data.data.u16[0];
     */
    EVENT_CODE_BUTTON_RELEASED = 0x05,

    // Движение мыши
    /* Использование контекста:
     * u16 x = data.data.u16[0];  // координата X
     * u16 y = data.data.u16[1];  // координата Y
     */
    EVENT_CODE_MOUSE_MOVED = 0x06,

    // Колесо мыши
    /* Использование контекста:
     * u8 z_delta = data.data.u8[0];  // изменение положения колеса
     */
    EVENT_CODE_MOUSE_WHEEL = 0x07,

    // Изменение размера окна/разрешения от ОС
    /* Использование контекста:
     * u16 width = data.data.u16[0];   // новая ширина
     * u16 height = data.data.u16[1];  // новая высота
     */
    EVENT_CODE_RESIZED = 0x08,

    // Максимальный системный код события
    MAX_EVENT_CODE = 0xFF
} system_event_code;
