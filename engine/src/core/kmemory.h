/*
  Это система управления памятью с тегами
  для отладки и профилирования
*/
#pragma once

#include "defines.h"

/*
  Назначение: Каждое выделение памяти помечается тегом. Это позволяет:
· Отслеживать утечки памяти по категориям
· Профилировать использование памяти
· Находить, кто выделяет много памяти
*/
typedef enum memory_tag {
    MEMORY_TAG_UNKNOWN,          // Для временного использования
    MEMORY_TAG_ARRAY,            // Обычные массивы
    MEMORY_TAG_DARRAY,           // Динамические массивы
    MEMORY_TAG_DICT,             // Словари/хэш-таблицы
    MEMORY_TAG_RING_QUEUE,       // Кольцевые буферы
    MEMORY_TAG_BST,              // Бинарные деревья поиска
    MEMORY_TAG_STRING,           // Строки
    MEMORY_TAG_APPLICATION,      // Данные приложения
    MEMORY_TAG_JOB,              // Задачи/работы (job system)
    MEMORY_TAG_TEXTURE,          // Текстуры
    MEMORY_TAG_MATERIAL_INSTANCE,// Материалы
    MEMORY_TAG_RENDERER,         // Рендерер
    MEMORY_TAG_GAME,             // Данные игры
    MEMORY_TAG_TRANSFORM,        // Трансформации объектов
    MEMORY_TAG_ENTITY,           // Сущности
    MEMORY_TAG_ENTITY_NODE,      // Узлы сущностей (иерархия)
    MEMORY_TAG_SCENE,            // Сцены
    
    MEMORY_TAG_MAX_TAGS          // Маркер конца (для массивов)
} memory_tag;

/*
 * Инициализирует систему управления памятью.
 * Должна быть вызвана перед любыми выделениями через kallocate.
 */
KAPI void initialize_memory();

/*
 * Завершает работу системы управления памятью.
 * Освобождает внутренние ресурсы и проверяет на утечки.
 */
KAPI void shutdown_memory();

/*
 * Выделяет блок памяти указанного размера с заданным тегом.
 * 
 * Параметры:
 *   size - размер в байтах для выделения
 *   tag  - категория памяти (для отладки и профилирования)
 * 
 * Возвращает:
 *   Указатель на выделенную память или NULL при ошибке
 */
KAPI void* kallocate(u64 size, memory_tag tag);

/*
 * Освобождает ранее выделенный блок памяти.
 * 
 * Параметры:
 *   block - указатель на блок для освобождения
 *   size  - размер блока (для проверок и статистики)
 *   tag   - тег, с которым был выделен блок
 * 
 * Примечание: Размер и тег нужны для проверки целостности
 * и ведения точной статистики.
 */
KAPI void kfree(void* block, u64 size, memory_tag tag);

/*
 * Обнуляет блок памяти заданного размера.
 * Полезно для инициализации структур.
 * 
 * Параметры:
 *   block - блок для обнуления
 *   size  - количество байт для обнуления
 * 
 * Возвращает:
 *   Указатель на обнулённый блок (тот же block)
 */
KAPI void* kzero_memory(void* block, u64 size);

/*
 * Копирует данные из source в dest.
 * 
 * Параметры:
 *   dest   - целевой блок памяти
 *   source - источник данных
 *   size   - количество байт для копирования
 * 
 * Возвращает:
 *   Указатель на dest
 */
KAPI void* kcopy_memory(void* dest, const void* source, u64 size);

/*
 * Заполняет блок памяти заданным значением.
 * 
 * Параметры:
 *   dest  - блок для заполнения
 *   value - значение для заполнения (преобразуется в unsigned char)
 *   size  - количество байт для заполнения
 * 
 * Возвращает:
 *   Указатель на dest
 */
KAPI void* kset_memory(void* dest, i32 value, u64 size);

/*
 * Возвращает строку с информацией об использовании памяти.
 * Формат: статистика по каждому тегу.
 * 
 * Пример вывода:
 *   "Unknown: 128B, Array: 1.5KB, Game: 24.3MB"
 * 
 * Возвращает:
 *   Статическую строку (не нужно освобождать)
 */
KAPI char* get_memory_usage_str();